!function(e){var s={},a={init:function(t){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",sysImg:"",sysUser:"",queryInterval:3e3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:"",webCache:!1,privateChannel:!1,privateChannelId:!1},this._options=e.extend(!0,{},this._defaults,t),this._options.queryIntElem=null,this._options.latest=null,this._options.debug&&(console.log("This object :"),console.log(this)),s=this._options,""==this._options.apiToken&&a.validationError("Parameter apiToken is required."),""==this._options.channelId&&a.validationError("Parameter channelId is required."),""==this._options.user&&a.validationError("Parameter user is required."),""==this._options.sysUser&&a.validationError("Parameter sysUser is required."),""==this._options.botUser&&a.validationError("Parameter botUser is required."),"undefined"==typeof moment&&a.validationError("MomentJS is not available. Get it from http://momentjs.com"),this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();var n='<div class="slackchat slack-chat-box">';n+='<div class="slack-chat-header">',n+='<button class="close slack-chat-close">&times;</button>',n+=this._options.chatBoxHeader,n+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>",n+="</div>",n+='<div class="slack-message-box">',n+="</div>",n+='<div class="send-area">',n+='<textarea class="form-control slack-new-message" type="text" placeholder="Write a message..."></textarea>',n+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>',n+="</div>",n+="</div>",e("body").append(n);var o=this;e(this).on("click",function(){if(e(".slack-chat-box").show(),e(".slack-chat-box").addClass("open"),e(".slack-message-box").height(e(".slack-chat-box").height()-e(".desc").height()-e(".send-area").height()-parseInt(o._options.heightOffset)),!function n(){e(".slack-chat-box").hasClass("open")&&(a.querySlack(o),setTimeout(n,o._options.queryInterval))}(),e(".slackchat .slack-new-message").focus(),o._options.webCache){var t={apiToken:s.apiToken,channelId:s.channelId,user:s.user,sysUser:s.sysUser,botUser:s.botUser};localStorage.scParams=JSON.stringify(t)}}),e(".slackchat .slack-chat-close").on("click",function(){e(".slack-chat-box").slideUp(),e(".slack-chat-box").removeClass("open"),clearInterval(o._options.queryIntElem)}),e(".slackchat .slack-post-message").click(function(){a.postMessage(o,o._options)}),e(".slackchat .slack-new-message").keyup(function(e){if(o._options.sendOnEnter){var s=e.keyCode?e.keyCode:e.which;13==s&&(a.postMessage(o,o._options),e.preventDefault())}}),a.getUserPresence(o,o._options)},querySlack:function(t){options=s,a.createChannel(t,function(t){s.channelId=t.id,e.ajax({url:"https://slack.com/api/channels.history",type:"POST",dataType:"json",data:{token:options.apiToken,channel:s.channelId,oldest:s.latest,count:options.messageFetchCount},success:function(t){if(options.debug&&t.messages&&t.messages.length&&console.log(t.messages),t.ok&&t.messages.length){var n="";s.latest=t.messages[0].ts,t.messages=t.messages.reverse();for(var o=0;o<t.messages.length;o++)if("bot_message"==t.messages[o].subtype&&""!==t.messages[o].text){message=t.messages[o];var i="",r="",l="";message.attachments&&(i=message.attachments[0].author_name,r=message.attachments[0].author_icon),message.fields&&(l=message.fields[0].value);var c=a.checkforLinks(message.text.trim());n+="<div class='message-item'>",""!==r&&"undefined"!=typeof r?n+="<div class='userImg'><img src='"+r+"' /></div>":""!==options.defaultUserImg&&(n+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>"),n+="<div class='msgBox'>",n+=""!==l?"<div class='username'>"+(l==options.userId?"You":i)+"</div>":"<div class='username'>"+i+"</div>",n+="<div class='message'>"+c+"</div>","undefined"!=typeof moment&&(n+="<div class='timestamp'>"+moment.unix(t.messages[o].ts).fromNow()+"</div>"),n+="</div>",n+="</div>"}else if("undefined"==typeof t.messages[o].subtype){message=t.messages[o].text;var i=options.sysUser,c=a.checkforLinks(message);n+="<div class='message-item'>",""!==options.sysImg&&(n+="<div class='userImg'><img src='"+options.sysImg+"' /></div>"),n+="<div class='msgBox'>",n+="<div class='username main'>"+i+"</div>",n+="<div class='message'>"+c+"</div>","undefined"!=typeof moment&&(n+="<div class='timestamp'>"+moment.unix(t.messages[o].ts).fromNow()+"</div>"),n+="</div>",n+="</div>"}e(".slack-message-box").append(n),e(".slack-message-box").stop().animate({scrollTop:e(".slack-message-box")[0].scrollHeight},800)}else t.ok||(console.log("[SlackChat] Query failed with errors: "),console.log(t))}})})},postMessage:function(a){var t=a._options,n={};n.fallback="View "+t.user+"'s profile",n.color=t.slackColor,n.author_name=t.user,""!==t.userLink&&(n.author_link=t.userLink),""!==t.userImg&&(n.author_icon=t.userImg),""!==t.userId&&(n.fields=[{title:"ID",value:t.userId,"short":!0}]),message=e(".slack-new-message").val(),e(".slack-new-message").val(""),t.debug&&(console.log("Posting Message:"),console.log({message:message,attachment:n,options:t})),e.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:t.apiToken,channel:s.channelId,text:message,username:t.botUser,attachments:JSON.stringify([n])},success:function(s){s.ok||(e(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),console.log(s))}})},validationError:function(s){return e.error("[SlackChat Error] "+s),!1},getUserPresence:function(s){var a=s._options,t=!1,n=[];e.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:a.apiToken},success:function(s){if(s.ok&&(n=s.members,n.length))for(var o=0;o<n.length&&!t;o++)n[o].is_bot||e.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:a.apiToken,user:n[o].id},success:function(s){if(s.ok){if("active"===s.presence)return e(".slackchat .presence").addClass("active"),e(".slackchat .presence .presence-text").text("Available"),a.disableIfAway&&null!==a.elementToDisable&&a.elementToDisable.show(),t=!0,!0;t||(e(".slackchat .presence").removeClass("active"),e(".slackchat .presence .presence-text").text("Away"))}}})}})},destroy:function(s){e(s).unbind("click"),e(".slackchat").remove()},checkforLinks:function(e){var s=/.*<[a-zA-Z0-9\/:\-.]+|[a-zA-Z0-9\/:\-.]+>.*/,a=0;if(s.test(e))for(;a<=e.indexOf("<http");){linkStartIndex=e.indexOf("<http"),linkEndIndex=e.indexOf(">",linkStartIndex)+1;var t=e.substring(linkStartIndex,linkEndIndex);a+=linkStartIndex+e.indexOf(">")+1;var n={};t.indexOf("|")?(n.url=t.substr(1,t.indexOf("|")-1),n.text=t.substring(t.indexOf("|")+1,t.length-1)):(n.url=t.substr(1,t.indexOf(">")-1),n.text=t.substring(t.indexOf(">")+1,t.length-1),n.text=n.url);var o="<a href='"+n.url+"' target='_blank'>"+n.text+"</a>";e=e.replace(t,o)}return e},createChannel:function(a,t){var n=a._options;if(!n.privateChannel){var o={id:n.channelId};return t(o),!1}if(n.privateChannelId){var o={id:n.privateChannelId};return t(o),!1}var i=n.user+""+1e7*Math.random();e.ajax({url:"https://slack.com/api/channels.create",dataType:"json",type:"POST",data:{token:n.apiToken,name:i},success:function(e){return e.ok&&(s.privateChannelId=e.channel.id,t(e.channel)),!1},error:function(){return!1}})}};e.fn.slackChat=function(s){return a[s]?a[s].apply(this,Array.prototype.slice.call(arguments,1)):void("object"!=typeof s&&s?e.error("Method "+s+" does not exist on jQuery.slackChat"):a.init.apply(this,arguments))}}(jQuery);